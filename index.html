<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer School Student Locations - California Counties</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
        html, body, #mapDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }
        
        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            max-width: 250px;
        }
        
        .legend-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .legend-symbol {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #333;
        }
        
        .color-bay-area { background-color: rgba(231, 76, 60, 0.7); }
        .color-los-angeles { background-color: rgba(243, 156, 18, 0.7); }
        .color-central-coast { background-color: rgba(52, 152, 219, 0.7); }
        .color-inland-empire { background-color: rgba(46, 204, 113, 0.7); }
        .color-san-diego { background-color: rgba(155, 89, 182, 0.7); }
        .color-sacramento { background-color: rgba(255, 193, 7, 0.7); }
        .color-washington { background-color: rgba(108, 117, 125, 0.7); }
        .color-colorado { background-color: rgba(220, 53, 69, 0.7); }
        .color-dc { background-color: rgba(23, 162, 184, 0.7); }
        .color-mexico { background-color: rgba(138, 43, 226, 0.7); }
        .color-other { background-color: rgba(200, 200, 200, 0.3); }
        
        #stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            max-width: 300px;
        }
        
        .stats-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .stats-item {
            font-size: 14px;
            margin: 5px 0;
            color: #555;
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="mapDiv"></div>
    <div id="tooltip"></div>
    <div id="loading">Loading map data...</div>
    
    <div id="legend">
        <div class="legend-title">Regions</div>
        <div class="legend-item">
            <div class="legend-symbol color-bay-area"></div>
            <span>Bay Area</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-los-angeles"></div>
            <span>Los Angeles</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-central-coast"></div>
            <span>Central Coast</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-inland-empire"></div>
            <span>Inland Empire</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-san-diego"></div>
            <span>San Diego</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-sacramento"></div>
            <span>Sacramento</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-washington"></div>
            <span>Washington State</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-colorado"></div>
            <span>Colorado</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-dc"></div>
            <span>Washington D.C.</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-mexico"></div>
            <span>Mexico</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-other"></div>
            <span>Other Counties</span>
        </div>
    </div>
    
    <div id="stats">
        <div class="stats-title">Summary Statistics</div>
        <div class="stats-item"><strong>Total Students:</strong> <span id="total-students">Loading...</span></div>
        <div class="stats-item"><strong>California:</strong> <span id="ca-students">Loading...</span></div>
        <div class="stats-item"><strong>Bay Area:</strong> <span id="bay-area-students">Loading...</span></div>
        <div class="stats-item"><strong>Los Angeles:</strong> <span id="la-students">Loading...</span></div>
        <div class="stats-item"><strong>Other States:</strong> <span id="other-states">Loading...</span></div>
        <div class="stats-item"><strong>International:</strong> <span id="international">Loading...</span></div>
        <div class="stats-item"><strong>Total Regions:</strong> <span id="total-regions">Loading...</span></div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer",
            "esri/geometry/Polygon",
            "esri/geometry/Point",
            "esri/PopupTemplate"
        ], function(Map, MapView, Graphic, GraphicsLayer, Polygon, Point, PopupTemplate) {
            
            // Create map
            const map = new Map({
                basemap: "streets-navigation-vector"
            });
            
            // Create map view
            const view = new MapView({
                container: "mapDiv",
                map: map,
                center: [-119, 37],
                zoom: 5
            });
            
            // Create graphics layers
            const californiaLayer = new GraphicsLayer();
            const statesLayer = new GraphicsLayer();
            const labelsLayer = new GraphicsLayer();
            map.add(californiaLayer);
            map.add(statesLayer);
            map.add(labelsLayer);

            // Regional mapping for California counties
            const countyToRegion = {
                // Bay Area
                'San Francisco': 'Bay Area',
                'Alameda': 'Bay Area',
                'Contra Costa': 'Bay Area',
                'Marin': 'Bay Area',
                'Napa': 'Bay Area',
                'San Mateo': 'Bay Area',
                'Santa Clara': 'Bay Area',
                'Solano': 'Bay Area',
                'Sonoma': 'Bay Area',
                
                // Los Angeles
                'Los Angeles': 'Los Angeles',
                
                // Central Coast
                'Monterey': 'Central Coast',
                'San Luis Obispo': 'Central Coast',
                'Santa Barbara': 'Central Coast',
                'Santa Cruz': 'Central Coast',
                'San Benito': 'Central Coast',
                'Ventura': 'Central Coast',
                
                // Inland Empire
                'Riverside': 'Inland Empire',
                'San Bernardino': 'Inland Empire',
                
                // San Diego
                'San Diego': 'San Diego',
                
                // Sacramento
                'Sacramento': 'Sacramento'
            };

            // State boundaries (approximate)
            const stateBoundaries = [
                {
                    name: "Washington State",
                    state: "WA",
                    students: 2,
                    coordinates: [
                        [[-125.0, 49.0], [-116.9, 49.0], [-116.9, 45.5], [-124.8, 45.5], [-125.0, 49.0]]]
                },
                {
                    name: "Colorado State",
                    state: "CO",
                    students: 1,
                    coordinates: [
                        [[-109.0, 41.0], [-102.0, 41.0], [-102.0, 37.0], [-109.0, 37.0], [-109.0, 41.0]]]
                },
                {
                    name: "Washington",
                    state: "D.C.",
                    students: 1,
                    coordinates: [
                        [[-77.2, 39.0], [-76.9, 39.0], [-76.9, 38.8], [-77.2, 38.8], [-77.2, 39.0]]]
                },
                {
                    name: "Mexico City",
                    state: "Mexico",
                    students: 1,
                    coordinates: [
                        [[-99.5, 19.8], [-98.8, 19.8], [-98.8, 19.1], [-99.5, 19.1], [-99.5, 19.8]]]
                }
            ];

            // Function to get fill color based on region
            function getFillSymbol(regionName) {
                let color;
                
                switch(regionName) {
                    case 'Bay Area':
                        color = [231, 76, 60, 0.7]; // Red
                        break;
                    case 'Los Angeles':
                        color = [243, 156, 18, 0.7]; // Orange
                        break;
                    case 'Central Coast':
                        color = [52, 152, 219, 0.7]; // Blue
                        break;
                    case 'Inland Empire':
                        color = [46, 204, 113, 0.7]; // Green
                        break;
                    case 'San Diego':
                        color = [155, 89, 182, 0.7]; // Purple
                        break;
                    case 'Sacramento':
                        color = [255, 193, 7, 0.7]; // Yellow
                        break;
                    case 'Washington State':
                        color = [108, 117, 125, 0.7]; // Gray
                        break;
                    case 'Colorado State':
                        color = [220, 53, 69, 0.7]; // Dark Red
                        break;
                    case 'Washington':
                        color = [23, 162, 184, 0.7]; // Teal
                        break;
                    case 'Mexico City':
                        color = [138, 43, 226, 0.7]; // Blue Violet
                        break;
                    default:
                        color = [200, 200, 200, 0.3]; // Light Gray for other counties
                }
                
                return {
                    type: "simple-fill",
                    color: color,
                    outline: {
                        color: [255, 255, 255],
                        width: 1
                    }
                };
            }

            // Load data and create map
            async function loadMapData() {
                try {
                    // Load student data
                    const csvResponse = await fetch('https://raw.githubusercontent.com/pluricalifornia/studentlocation/main/data/SummerSchoolLocations.csv');
                    const csvText = await csvResponse.text();
                    
                    // Parse CSV data
                    const lines = csvText.split('\n').filter(line => line.trim());
                    const studentData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const [city, state] = lines[i].split(',').map(s => s.trim().replace(/"/g, ''));
                        if (city && state) {
                            studentData.push({ city, state });
                        }
                    }

                    // Count students by region
                    const regionCounts = {};
                    studentData.forEach(student => {
                        const region = `${student.city}, ${student.state}`;
                        regionCounts[region] = (regionCounts[region] || 0) + 1;
                    });

                    // Load California counties JSON
                    const geoResponse = await fetch('https://raw.githubusercontent.com/pluricalifornia/studentlocation/main/data/CA_COUNTIES.json');
                    const geoData = await geoResponse.json();

                    // Debug: Log all county names to see what's in the data
                    console.log('County names in data:');
                    geoData.features.forEach(feature => {
                        console.log(`"${feature.properties.NAME}"`);
                    });

                    // Group California counties by region and count students
                    const caRegionCounts = {
                        'Bay Area': 0,
                        'Los Angeles': 0,
                        'Central Coast': 0,
                        'Inland Empire': 0,
                        'San Diego': 0,
                        'Sacramento': 0
                    };

                    // Count students by California region
                    Object.entries(regionCounts).forEach(([region, count]) => {
                        if (region.includes(', CA')) {
                            const cityName = region.split(', ')[0];
                            if (cityName === 'Bay Area') caRegionCounts['Bay Area'] += count;
                            else if (cityName === 'Los Angeles') caRegionCounts['Los Angeles'] += count;
                            else if (cityName === 'Central Coast') caRegionCounts['Central Coast'] += count;
                            else if (cityName === 'Inland Empire') caRegionCounts['Inland Empire'] += count;
                            else if (cityName === 'San Diego') caRegionCounts['San Diego'] += count;
                            else if (cityName === 'Sacramento') caRegionCounts['Sacramento'] += count;
                        }
                    });

                    // Add California counties to map
                    geoData.features.forEach(feature => {
                        const countyName = feature.properties.NAME;
                        const regionName = countyToRegion[countyName] || 'Other';
                        const studentCount = caRegionCounts[regionName] || 0;

                        let polygon;

                        // Handle both Polygon and MultiPolygon geometries
                        if (feature.geometry.type === "Polygon") {
                            const rings = feature.geometry.coordinates.map(ring => 
                                ring.map(coord => [coord[0], coord[1]])
                            );
                            polygon = new Polygon({
                                rings: rings,
                                spatialReference: { wkid: 3857 }
                            });
                        } else if (feature.geometry.type === "MultiPolygon") {
                            // For MultiPolygon, we need to flatten the structure
                            const allRings = [];
                            feature.geometry.coordinates.forEach(polygonCoords => {
                                polygonCoords.forEach(ring => {
                                    allRings.push(ring.map(coord => [coord[0], coord[1]]));
                                });
                            });
                            polygon = new Polygon({
                                rings: allRings,
                                spatialReference: { wkid: 3857 }
                            });
                        }

                        const popupTemplate = new PopupTemplate({
                            title: `${countyName} County`,
                            content: `
                                <div style="padding: 10px;">
                                    <p><strong>County:</strong> ${countyName}</p>
                                    <p><strong>Region:</strong> ${regionName}</p>
                                    <p><strong>Students in Region:</strong> ${studentCount}</p>
                                    <p><strong>Percentage:</strong> ${((studentCount / studentData.length) * 100).toFixed(1)}% of total</p>
                                    <p><strong>Geometry:</strong> ${feature.geometry.type}</p>
                                </div>
                            `
                        });

                        const graphic = new Graphic({
                            geometry: polygon,
                            symbol: getFillSymbol(regionName),
                            popupTemplate: popupTemplate,
                            attributes: {
                                name: countyName,
                                region: regionName,
                                students: studentCount
                            }
                        });

                        californiaLayer.add(graphic);
                    });

                    // Add state boundaries
                    stateBoundaries.forEach(boundary => {
                        const studentCount = regionCounts[`${boundary.name}, ${boundary.state}`] || 0;
                        
                        const polygon = new Polygon({
                            rings: boundary.coordinates
                        });

                        const popupTemplate = new PopupTemplate({
                            title: `${boundary.name}${boundary.state !== 'Mexico' ? ', ' + boundary.state : ''}`,
                            content: `
                                <div style="padding: 10px;">
                                    <p><strong>Students:</strong> ${studentCount}</p>
                                    <p><strong>Location:</strong> ${boundary.name}${boundary.state !== 'Mexico' ? ', ' + boundary.state : ''}</p>
                                    <p><strong>Percentage:</strong> ${((studentCount / studentData.length) * 100).toFixed(1)}% of total</p>
                                    ${boundary.state === "Mexico" ? '<p><em>International students</em></p>' : ''}
                                </div>
                            `
                        });

                        const graphic = new Graphic({
                            geometry: polygon,
                            symbol: getFillSymbol(boundary.name === 'Mexico City' ? 'Mexico City' : boundary.name === 'Colorado State' ? 'Colorado State' : boundary.name === 'Washington' ? 'Washington' : 'Washington State'),
                            popupTemplate: popupTemplate,
                            attributes: {
                                name: boundary.name,
                                state: boundary.state,
                                students: studentCount
                            }
                        });

                        statesLayer.add(graphic);
                    });

                    // Update statistics
                    const caStudents = Object.values(caRegionCounts).reduce((a, b) => a + b, 0);
                    const otherStates = Object.values(regionCounts).reduce((sum, count, index, arr) => {
                        const key = Object.keys(regionCounts)[index];
                        return key.includes(', CA') ? sum : sum + count;
                    }, 0) - (regionCounts['Mexico City, Mexico'] || 0);
                    
                    document.getElementById('total-students').textContent = studentData.length;
                    document.getElementById('ca-students').textContent = `${caStudents} (${((caStudents/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('bay-area-students').textContent = `${caRegionCounts['Bay Area']} (${((caRegionCounts['Bay Area']/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('la-students').textContent = `${caRegionCounts['Los Angeles']} (${((caRegionCounts['Los Angeles']/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('other-states').textContent = `${otherStates} (${((otherStates/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('international').textContent = `${regionCounts['Mexico City, Mexico'] || 0} (${(((regionCounts['Mexico City, Mexico'] || 0)/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('total-regions').textContent = Object.keys(regionCounts).length;

                    // Add region labels
                    const regionCenters = {
                        'Bay Area': { lat: 37.8272, lon: -122.2913 },
                        'Los Angeles': { lat: 34.0522, lon: -118.2437 },
                        'Central Coast': { lat: 35.3738, lon: -120.8509 },
                        'Inland Empire': { lat: 34.0396, lon: -116.9742 }, // Centered around Yucaipa
                        'San Diego': { lat: 32.7157, lon: -117.1611 },
                        'Sacramento': { lat: 38.5816, lon: -121.4944 },
                        'Washington State': { lat: 47.7511, lon: -120.7401 },
                        'Colorado State': { lat: 39.5501, lon: -105.7821 },
                        'Washington': { lat: 38.9072, lon: -77.0369 },
                        'Mexico City': { lat: 19.4326, lon: -99.1332 }
                    };

                    Object.entries(caRegionCounts).forEach(([regionName, count]) => {
                        if (count > 0 && regionCenters[regionName]) {
                            const center = regionCenters[regionName];
                            const point = new Point({
                                longitude: center.lon,
                                latitude: center.lat
                            });

                            const labelGraphic = new Graphic({
                                geometry: point,
                                symbol: {
                                    type: "text",
                                    color: [0, 0, 0],
                                    haloColor: [255, 255, 255],
                                    haloSize: "2px",
                                    text: `${regionName}\n${count} ${count === 1 ? 'student' : 'students'}`,
                                    font: {
                                        size: "14px",
                                        family: "Arial",
                                        weight: "bold"
                                    }
                                }
                            });

                            labelsLayer.add(labelGraphic);
                        }
                    });

                    // Add labels for other states/countries
                    stateBoundaries.forEach(boundary => {
                        const studentCount = regionCounts[`${boundary.name}, ${boundary.state}`] || 0;
                        if (studentCount > 0 && regionCenters[boundary.name] || regionCenters[boundary.name === 'Mexico City' ? 'Mexico City' : boundary.name]) {
                            const centerKey = boundary.name === 'Mexico City' ? 'Mexico City' : boundary.name;
                            const center = regionCenters[centerKey];
                            if (center) {
                                const point = new Point({
                                    longitude: center.lon,
                                    latitude: center.lat
                                });

                                const labelGraphic = new Graphic({
                                    geometry: point,
                                    symbol: {
                                        type: "text",
                                        color: [0, 0, 0],
                                        haloColor: [255, 255, 255],
                                        haloSize: "2px",
                                        text: `${boundary.name}${boundary.state !== 'Mexico' ? ', ' + boundary.state : ''}\n${studentCount} student${studentCount !== 1 ? 's' : ''}`,
                                        font: {
                                            size: "14px",
                                            family: "Arial",
                                            weight: "bold"
                                        }
                                    }
                                });

                                labelsLayer.add(labelGraphic);
                            }
                        }
                    });

                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';

                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('loading').innerHTML = 'Error loading data. Please check the GitHub repository.';
                }
            }

            // Add hover effects
            let tooltip = document.getElementById('tooltip');
            
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    if (response.results.length > 0) {
                        const graphic = response.results[0].graphic;
                        if (graphic && graphic.attributes) {
                            tooltip.style.display = 'block';
                            tooltip.style.left = event.x + 10 + 'px';
                            tooltip.style.top = event.y - 30 + 'px';
                            
                            if (graphic.attributes.region) {
                                // California county
                                tooltip.innerHTML = `
                                    <strong>${graphic.attributes.name} County</strong><br>
                                    Region: ${graphic.attributes.region}<br>
                                    ${graphic.attributes.students} student${graphic.attributes.students !== 1 ? 's' : ''} in region
                                `;
                            } else {
                                // State/international
                                tooltip.innerHTML = `
                                    <strong>${graphic.attributes.name}</strong><br>
                                    ${graphic.attributes.students} student${graphic.attributes.students !== 1 ? 's' : ''}
                                `;
                            }
                            view.container.style.cursor = 'pointer';
                        }
                    } else {
                        tooltip.style.display = 'none';
                        view.container.style.cursor = 'default';
                    }
                });
            });

            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
                view.container.style.cursor = 'default';
            });

            // Initialize map
            view.when(() => {
                loadMapData().then(() => {
                    // Adjust view to show California
                    view.goTo({
                        center: [-119, 37],
                        zoom: 6
                    });
                });
            });
        });
    </script>
</body>
</html>
