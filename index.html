<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer School Student Locations - California Counties</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
        html, body, #mapDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }
        
        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            max-width: 250px;
        }
        
        .legend-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .legend-symbol {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #333;
        }
        
        .color-very-high { background-color: rgba(231, 76, 60, 0.7); }
        .color-high { background-color: rgba(243, 156, 18, 0.7); }
        .color-medium { background-color: rgba(52, 152, 219, 0.7); }
        .color-low { background-color: rgba(46, 204, 113, 0.7); }
        .color-international { background-color: rgba(155, 89, 182, 0.7); }
        .color-none { background-color: rgba(200, 200, 200, 0.3); }
        
        #stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            max-width: 300px;
        }
        
        .stats-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .stats-item {
            font-size: 14px;
            margin: 5px 0;
            color: #555;
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="mapDiv"></div>
    <div id="tooltip"></div>
    <div id="loading">Loading map data...</div>
    
    <div id="legend">
        <div class="legend-title">Student Distribution</div>
        <div class="legend-item">
            <div class="legend-symbol color-very-high"></div>
            <span>10+ Students</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-high"></div>
            <span>5-9 Students</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-medium"></div>
            <span>2-4 Students</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-low"></div>
            <span>1 Student</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-international"></div>
            <span>International</span>
        </div>
        <div class="legend-item">
            <div class="legend-symbol color-none"></div>
            <span>No Students</span>
        </div>
    </div>
    
    <div id="stats">
        <div class="stats-title">Summary Statistics</div>
        <div class="stats-item"><strong>Total Students:</strong> <span id="total-students">Loading...</span></div>
        <div class="stats-item"><strong>California:</strong> <span id="ca-students">Loading...</span></div>
        <div class="stats-item"><strong>Bay Area:</strong> <span id="bay-area-students">Loading...</span></div>
        <div class="stats-item"><strong>Los Angeles:</strong> <span id="la-students">Loading...</span></div>
        <div class="stats-item"><strong>Other States:</strong> <span id="other-states">Loading...</span></div>
        <div class="stats-item"><strong>International:</strong> <span id="international">Loading...</span></div>
        <div class="stats-item"><strong>Total Regions:</strong> <span id="total-regions">Loading...</span></div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer",
            "esri/geometry/Polygon",
            "esri/PopupTemplate"
        ], function(Map, MapView, Graphic, GraphicsLayer, Polygon, PopupTemplate) {
            
            // Create map
            const map = new Map({
                basemap: "streets-navigation-vector"
            });
            
            // Create map view
            const view = new MapView({
                container: "mapDiv",
                map: map,
                center: [-119, 37],
                zoom: 5
            });
            
            // Create graphics layers
            const californiaLayer = new GraphicsLayer();
            const statesLayer = new GraphicsLayer();
            map.add(californiaLayer);
            map.add(statesLayer);

            // Regional mapping for California counties
            const countyToRegion = {
                // Bay Area
                'San Francisco': 'Bay Area',
                'Alameda': 'Bay Area',
                'Contra Costa': 'Bay Area',
                'Marin': 'Bay Area',
                'Napa': 'Bay Area',
                'San Mateo': 'Bay Area',
                'Santa Clara': 'Bay Area',
                'Solano': 'Bay Area',
                'Sonoma': 'Bay Area',
                
                // Los Angeles
                'Los Angeles': 'Los Angeles',
                
                // Central Coast
                'Monterey': 'Central Coast',
                'Ventura': 'Central Coast',
                'San Luis Obispo': 'Central Coast',
                'Santa Barbara': 'Central Coast',
                'Santa Cruz': 'Central Coast',
                'San Benito': 'Central Coast',
                
                // Inland Empire
                'Riverside': 'Inland Empire',
                'San Bernardino': 'Inland Empire',
                
                // San Diego
                'San Diego': 'San Diego',
                
                // Sacramento
                'Sacramento': 'Sacramento',
                'Placer': 'Sacramento',
                'El Dorado': 'Sacramento',
                'Yolo': 'Sacramento',
                'Sutter': 'Sacramento',
                'Yuba': 'Sacramento'
            };

            // State boundaries (approximate)
            const stateBoundaries = [
                {
                    name: "Washington State",
                    state: "WA",
                    students: 2,
                    coordinates: [
                        [[-125.0, 49.0], [-116.9, 49.0], [-116.9, 45.5], [-124.8, 45.5], [-125.0, 49.0]]]
                },
                {
                    name: "Colorado State",
                    state: "CO",
                    students: 1,
                    coordinates: [
                        [[-109.0, 41.0], [-102.0, 41.0], [-102.0, 37.0], [-109.0, 37.0], [-109.0, 41.0]]]
                },
                {
                    name: "Washington",
                    state: "D.C.",
                    students: 1,
                    coordinates: [
                        [[-77.2, 39.0], [-76.9, 39.0], [-76.9, 38.8], [-77.2, 38.8], [-77.2, 39.0]]]
                },
                {
                    name: "Mexico City",
                    state: "Mexico",
                    students: 1,
                    coordinates: [
                        [[-99.5, 19.8], [-98.8, 19.8], [-98.8, 19.1], [-99.5, 19.1], [-99.5, 19.8]]]
                }
            ];

            // Function to get fill color based on student count
            function getFillSymbol(students, isInternational = false) {
                let color;
                
                if (isInternational) {
                    color = [155, 89, 182, 0.7]; // Purple for international
                } else if (students >= 10) {
                    color = [231, 76, 60, 0.7]; // Red for very high count
                } else if (students >= 5) {
                    color = [243, 156, 18, 0.7]; // Orange for high count  
                } else if (students >= 2) {
                    color = [52, 152, 219, 0.7]; // Blue for medium count
                } else if (students >= 1) {
                    color = [46, 204, 113, 0.7]; // Green for single student
                } else {
                    color = [200, 200, 200, 0.3]; // Gray for no students
                }
                
                return {
                    type: "simple-fill",
                    color: color,
                    outline: {
                        color: [255, 255, 255],
                        width: 1
                    }
                };
            }

            // Load data and create map
            async function loadMapData() {
                try {
                    // Load student data
                    const csvResponse = await fetch('https://raw.githubusercontent.com/pluricalifornia/studentlocation/main/data/SummerSchoolLocations.csv');
                    const csvText = await csvResponse.text();
                    
                    // Parse CSV data
                    const lines = csvText.split('\n').filter(line => line.trim());
                    const studentData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const [city, state] = lines[i].split(',').map(s => s.trim().replace(/"/g, ''));
                        if (city && state) {
                            studentData.push({ city, state });
                        }
                    }

                    // Count students by region
                    const regionCounts = {};
                    studentData.forEach(student => {
                        const region = `${student.city}, ${student.state}`;
                        regionCounts[region] = (regionCounts[region] || 0) + 1;
                    });

                    // Load California counties JSON
                    const geoResponse = await fetch('https://raw.githubusercontent.com/pluricalifornia/studentlocation/main/data/CA_COUNTIES.json');
                    const geoData = await geoResponse.json();

                    // Group California counties by region and count students
                    const caRegionCounts = {
                        'Bay Area': 0,
                        'Los Angeles': 0,
                        'Central Coast': 0,
                        'Inland Empire': 0,
                        'San Diego': 0,
                        'Sacramento': 0
                    };

                    // Count students by California region
                    Object.entries(regionCounts).forEach(([region, count]) => {
                        if (region.includes(', CA')) {
                            const cityName = region.split(', ')[0];
                            if (cityName === 'Bay Area') caRegionCounts['Bay Area'] += count;
                            else if (cityName === 'Los Angeles') caRegionCounts['Los Angeles'] += count;
                            else if (cityName === 'Central Coast') caRegionCounts['Central Coast'] += count;
                            else if (cityName === 'Inland Empire') caRegionCounts['Inland Empire'] += count;
                            else if (cityName === 'San Diego') caRegionCounts['San Diego'] += count;
                            else if (cityName === 'Sacramento') caRegionCounts['Sacramento'] += count;
                        }
                    });

                    // Add California counties to map
                    geoData.features.forEach(feature => {
                        const countyName = feature.properties.NAME;
                        const regionName = countyToRegion[countyName] || 'Other';
                        const studentCount = caRegionCounts[regionName] || 0;

                        // Convert coordinates from EPSG:3857 to geographic coordinates
                        // The coordinates are already in the projected system, so we need to handle them properly
                        const rings = feature.geometry.coordinates.map(ring => {
                            if (feature.geometry.type === "Polygon") {
                                return ring.map(coord => [coord[0], coord[1]]);
                            } else {
                                // Handle MultiPolygon if needed
                                return ring;
                            }
                        });

                        const polygon = new Polygon({
                            rings: rings,
                            spatialReference: { wkid: 3857 } // Web Mercator projection
                        });

                        const popupTemplate = new PopupTemplate({
                            title: `${countyName} County`,
                            content: `
                                <div style="padding: 10px;">
                                    <p><strong>County:</strong> ${countyName}</p>
                                    <p><strong>Region:</strong> ${regionName}</p>
                                    <p><strong>Students in Region:</strong> ${studentCount}</p>
                                    <p><strong>Percentage:</strong> ${((studentCount / studentData.length) * 100).toFixed(1)}% of total</p>
                                </div>
                            `
                        });

                        const graphic = new Graphic({
                            geometry: polygon,
                            symbol: getFillSymbol(studentCount),
                            popupTemplate: popupTemplate,
                            attributes: {
                                name: countyName,
                                region: regionName,
                                students: studentCount
                            }
                        });

                        californiaLayer.add(graphic);
                    });

                    // Add state boundaries
                    stateBoundaries.forEach(boundary => {
                        const studentCount = regionCounts[`${boundary.name}, ${boundary.state}`] || 0;
                        
                        const polygon = new Polygon({
                            rings: boundary.coordinates
                        });

                        const popupTemplate = new PopupTemplate({
                            title: `${boundary.name}${boundary.state !== 'Mexico' ? ', ' + boundary.state : ''}`,
                            content: `
                                <div style="padding: 10px;">
                                    <p><strong>Students:</strong> ${studentCount}</p>
                                    <p><strong>Location:</strong> ${boundary.name}${boundary.state !== 'Mexico' ? ', ' + boundary.state : ''}</p>
                                    <p><strong>Percentage:</strong> ${((studentCount / studentData.length) * 100).toFixed(1)}% of total</p>
                                    ${boundary.state === "Mexico" ? '<p><em>International students</em></p>' : ''}
                                </div>
                            `
                        });

                        const graphic = new Graphic({
                            geometry: polygon,
                            symbol: getFillSymbol(studentCount, boundary.state === 'Mexico'),
                            popupTemplate: popupTemplate,
                            attributes: {
                                name: boundary.name,
                                state: boundary.state,
                                students: studentCount
                            }
                        });

                        statesLayer.add(graphic);
                    });

                    // Update statistics
                    const caStudents = Object.values(caRegionCounts).reduce((a, b) => a + b, 0);
                    const otherStates = Object.values(regionCounts).reduce((sum, count, index, arr) => {
                        const key = Object.keys(regionCounts)[index];
                        return key.includes(', CA') ? sum : sum + count;
                    }, 0) - (regionCounts['Mexico City, Mexico'] || 0);
                    
                    document.getElementById('total-students').textContent = studentData.length;
                    document.getElementById('ca-students').textContent = `${caStudents} (${((caStudents/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('bay-area-students').textContent = `${caRegionCounts['Bay Area']} (${((caRegionCounts['Bay Area']/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('la-students').textContent = `${caRegionCounts['Los Angeles']} (${((caRegionCounts['Los Angeles']/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('other-states').textContent = `${otherStates} (${((otherStates/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('international').textContent = `${regionCounts['Mexico City, Mexico'] || 0} (${(((regionCounts['Mexico City, Mexico'] || 0)/studentData.length)*100).toFixed(1)}%)`;
                    document.getElementById('total-regions').textContent = Object.keys(regionCounts).length;

                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';

                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('loading').innerHTML = 'Error loading data. Please check the GitHub repository.';
                }
            }

            // Add hover effects
            let tooltip = document.getElementById('tooltip');
            
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    if (response.results.length > 0) {
                        const graphic = response.results[0].graphic;
                        if (graphic && graphic.attributes) {
                            tooltip.style.display = 'block';
                            tooltip.style.left = event.x + 10 + 'px';
                            tooltip.style.top = event.y - 30 + 'px';
                            
                            if (graphic.attributes.region) {
                                // California county
                                tooltip.innerHTML = `
                                    <strong>${graphic.attributes.name} County</strong><br>
                                    Region: ${graphic.attributes.region}<br>
                                    ${graphic.attributes.students} student${graphic.attributes.students !== 1 ? 's' : ''} in region
                                `;
                            } else {
                                // State/international
                                tooltip.innerHTML = `
                                    <strong>${graphic.attributes.name}</strong><br>
                                    ${graphic.attributes.students} student${graphic.attributes.students !== 1 ? 's' : ''}
                                `;
                            }
                            view.container.style.cursor = 'pointer';
                        }
                    } else {
                        tooltip.style.display = 'none';
                        view.container.style.cursor = 'default';
                    }
                });
            });

            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
                view.container.style.cursor = 'default';
            });

            // Initialize map
            view.when(() => {
                loadMapData().then(() => {
                    // Adjust view to show California
                    view.goTo({
                        center: [-119, 37],
                        zoom: 6
                    });
                });
            });
        });
    </script>
</body>
</html>
